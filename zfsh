#!/bin/bash
# ZFSh - ZFS Shell Helpers
# Unified entry point for ZFS management scripts
# Version: 0.0.1
#
# Usage:
#   zfsh                    Interactive mode (menu)
#   zfsh <command> [args]   CLI mode
#
# Commands: pool, snapshot, backup, incus, cron

set -euo pipefail

VERSION="0.0.1"
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
source "$SCRIPT_DIR/common.sh"

# =============================================================================
# COLORS & STYLING
# =============================================================================
C_HEADER='\033[1;36m'     # Bold Cyan
C_MENU_NUM='\033[1;33m'   # Bold Yellow
C_MENU_TEXT='\033[0;37m'  # Light Gray
C_MENU_DESC='\033[0;90m'  # Dark Gray
C_PROMPT='\033[1;32m'     # Bold Green
C_SEP='\033[0;90m'        # Dark Gray
C_TITLE='\033[1;97m'      # Bold White
C_RESET='\033[0m'

# =============================================================================
# BANNER & DISPLAY
# =============================================================================
show_banner() {
    echo -e "${C_HEADER}"
    cat << 'EOF'
╔══════════════════════════════════════════════════════════════╗
EOF
    printf "║%s%s%-62s%s║\n" "${C_TITLE}" " " "ZFSh v${VERSION}" "${C_HEADER}"
    cat << 'EOF'
╚══════════════════════════════════════════════════════════════╝
EOF
    echo -e "${C_RESET}"
}

show_version() {
    echo "ZFSh v${VERSION}"
    echo "Location: $SCRIPT_DIR"
}

draw_separator() {
    local width="${1:-40}"
    echo -e "${C_SEP}$(printf '─%.0s' $(seq 1 $width))${C_RESET}"
}

menu_item() {
    local num="$1"
    local text="$2"
    local desc="${3:-}"
    
    if [[ -n "$desc" ]]; then
        printf "  ${C_MENU_NUM}%s.${C_RESET} ${C_MENU_TEXT}%-22s${C_RESET} ${C_MENU_DESC}%s${C_RESET}\n" "$num" "$text" "$desc"
    else
        printf "  ${C_MENU_NUM}%s.${C_RESET} ${C_MENU_TEXT}%s${C_RESET}\n" "$num" "$text"
    fi
}

menu_header() {
    local title="$1"
    echo ""
    echo -e "${C_TITLE}${title}${C_RESET}"
    draw_separator ${#title}
}

press_enter() {
    echo ""
    echo -e "${C_MENU_DESC}Press Enter to continue...${C_RESET}"
    read -r
}

read_choice() {
    local prompt="${1:-Select}"
    echo ""
    echo -ne "${C_PROMPT}${prompt}: ${C_RESET}"
    read -r REPLY
}

clear_screen() {
    clear
    show_banner
}

# =============================================================================
# HELP
# =============================================================================
show_help() {
    cat << EOF
${C_TITLE}ZFSh v${VERSION}${C_RESET}
$(draw_separator 23)

${C_HEADER}Usage:${C_RESET}
  zfsh                              Interactive mode (menu)
  zfsh <command> [options]          CLI mode

${C_HEADER}Commands:${C_RESET}
  pool        Manage ZFS pools
  snapshot    Manage snapshots
  backup      Backup and restore
  incus       Incus integration
  cron        Scheduled tasks

${C_HEADER}Pool Commands:${C_RESET}
  zfsh pool create     Create new ZFS pool on sparse file
  zfsh pool info       Show detailed pool information
  zfsh pool expand     Expand pool size
  zfsh pool health     Run health check with recommendations

${C_HEADER}Snapshot Commands:${C_RESET}
  zfsh snapshot create    Create snapshot
  zfsh snapshot list      List snapshots with filters
  zfsh snapshot delete    Delete snapshots
  zfsh snapshot rollback  Rollback to snapshot
  zfsh snapshot cleanup   Apply retention policy (GFS)

${C_HEADER}Backup Commands:${C_RESET}
  zfsh backup create    Create local backup (zfs send)
  zfsh backup restore   Restore from backup (zfs receive)
  zfsh backup list      List backup files
  zfsh backup verify    Verify backup integrity
  zfsh backup send      Send to remote server via SSH
  zfsh backup cleanup   Remove old backups

${C_HEADER}Incus Commands:${C_RESET}
  zfsh incus init       Initialize Incus with ZFS pool

${C_HEADER}Cron Commands:${C_RESET}
  zfsh cron add         Add scheduled task
  zfsh cron list        List scheduled tasks
  zfsh cron remove      Remove task by ID
  zfsh cron test        Test run a task

${C_HEADER}Global Options:${C_RESET}
  -j, --json            Output as JSON
  -l, --log FILE        Log to file
  -q, --quiet           Minimal output
  -v, --version         Show version
  -h, --help            Show this help

${C_HEADER}Examples:${C_RESET}
  zfsh                                        Interactive menu
  zfsh pool create -s 50G -c zstd -y         Create 50G pool
  zfsh snapshot cleanup default --keep-daily 7 --keep-weekly 4
  zfsh backup send default user@backup:tank/backups --progress
  zfsh cron add --type snapshot --pool default --daily

EOF
}

show_category_help() {
    local category="$1"
    
    case "$category" in
        pool)
            "$SCRIPT_DIR/zfs-pool-create.sh" --help 2>/dev/null || true
            ;;
        snapshot)
            "$SCRIPT_DIR/zfs-snapshot.sh" --help 2>/dev/null || true
            ;;
        backup)
            "$SCRIPT_DIR/zfs-backup.sh" --help 2>/dev/null || true
            ;;
        incus)
            "$SCRIPT_DIR/zfs-incus-init.sh" --help 2>/dev/null || true
            ;;
        cron)
            "$SCRIPT_DIR/zfs-cron-setup.sh" --help 2>/dev/null || true
            ;;
        *)
            show_help
            ;;
    esac
}

# =============================================================================
# INTERACTIVE HELPERS
# =============================================================================
select_pool() {
    local pools
    pools=$(zpool list -H -o name 2>/dev/null || true)
    
    if [[ -z "$pools" ]]; then
        echo "No ZFS pools found"
        return 1
    fi
    
    echo "Available pools:"
    local i=1
    local -a pool_array=()
    while IFS= read -r pool; do
        local size health
        size=$(zpool get -H -o value size "$pool" 2>/dev/null || echo "?")
        health=$(zpool get -H -o value health "$pool" 2>/dev/null || echo "?")
        menu_item "$i" "$pool" "($size, $health)"
        pool_array+=("$pool")
        ((i++))
    done <<< "$pools"
    
    read_choice "Select pool [1-${#pool_array[@]}]"
    
    if [[ "$REPLY" =~ ^[0-9]+$ ]] && [[ "$REPLY" -ge 1 ]] && [[ "$REPLY" -le ${#pool_array[@]} ]]; then
        SELECTED_POOL="${pool_array[$((REPLY-1))]}"
        return 0
    fi
    return 1
}

select_dataset() {
    local pool="${1:-}"
    local datasets
    
    if [[ -n "$pool" ]]; then
        datasets=$(zfs list -H -o name -r "$pool" 2>/dev/null || true)
    else
        datasets=$(zfs list -H -o name 2>/dev/null || true)
    fi
    
    if [[ -z "$datasets" ]]; then
        echo "No datasets found"
        return 1
    fi
    
    echo "Available datasets:"
    local i=1
    local -a ds_array=()
    while IFS= read -r ds; do
        menu_item "$i" "$ds"
        ds_array+=("$ds")
        ((i++))
    done <<< "$datasets"
    
    read_choice "Select dataset [1-${#ds_array[@]}]"
    
    if [[ "$REPLY" =~ ^[0-9]+$ ]] && [[ "$REPLY" -ge 1 ]] && [[ "$REPLY" -le ${#ds_array[@]} ]]; then
        SELECTED_DATASET="${ds_array[$((REPLY-1))]}"
        return 0
    fi
    return 1
}

run_script() {
    local script="$1"
    shift
    
    echo ""
    draw_separator 60
    
    if [[ -x "$SCRIPT_DIR/$script" ]]; then
        "$SCRIPT_DIR/$script" "$@"
        local result=$?
        draw_separator 60
        return $result
    else
        error "Script not found: $script"
        return 1
    fi
}

# =============================================================================
# MENUS
# =============================================================================
menu_main() {
    while true; do
        clear_screen
        
        menu_item "1" "Pool Management" "Create, expand, info, health check"
        menu_item "2" "Snapshot Management" "Create, list, delete, rollback, cleanup"
        menu_item "3" "Backup & Restore" "Local backups, remote send, restore"
        menu_item "4" "Incus Integration" "Initialize, configure storage"
        menu_item "5" "Scheduled Tasks" "Manage cron jobs for automation"
        menu_item "6" "Quick Actions" "Common operations"
        echo ""
        echo -e "  ${C_MENU_NUM}h.${C_RESET} ${C_MENU_TEXT}Help${C_RESET}    ${C_MENU_NUM}q.${C_RESET} ${C_MENU_TEXT}Quit${C_RESET}"
        
        read_choice "Select [1-6, h, q]"
        
        case "$REPLY" in
            1) menu_pool ;;
            2) menu_snapshot ;;
            3) menu_backup ;;
            4) menu_incus ;;
            5) menu_cron ;;
            6) menu_quick ;;
            h|H) show_help; press_enter ;;
            q|Q) echo "Goodbye!"; exit 0 ;;
            *) ;;
        esac
    done
}

menu_pool() {
    while true; do
        clear_screen
        menu_header "Pool Management"
        
        menu_item "1" "Create new pool" "Create ZFS pool on sparse file"
        menu_item "2" "Show pool info" "Display pool details and properties"
        menu_item "3" "Expand pool" "Increase pool size"
        menu_item "4" "Health check" "Check status and recommendations"
        menu_item "5" "List all pools" "Show all available ZFS pools"
        echo ""
        menu_item "b" "Back to main menu"
        
        read_choice "Select"
        
        case "$REPLY" in
            1)
                run_script "zfs-pool-create.sh"
                press_enter
                ;;
            2)
                if select_pool; then
                    run_script "zfs-pool-info.sh" "$SELECTED_POOL" -a
                fi
                press_enter
                ;;
            3)
                if select_pool; then
                    run_script "zfs-pool-expand.sh" "$SELECTED_POOL"
                fi
                press_enter
                ;;
            4)
                echo ""
                echo "Check specific pool or all pools?"
                menu_item "1" "Specific pool"
                menu_item "2" "All pools"
                read_choice "Select"
                
                if [[ "$REPLY" == "1" ]]; then
                    if select_pool; then
                        run_script "zfs-pool-health.sh" "$SELECTED_POOL"
                    fi
                else
                    run_script "zfs-pool-health.sh" --all
                fi
                press_enter
                ;;
            5)
                echo ""
                zpool list 2>/dev/null || echo "No pools found"
                press_enter
                ;;
            b|B) return ;;
            *) ;;
        esac
    done
}

menu_snapshot() {
    while true; do
        clear_screen
        menu_header "Snapshot Management"
        
        menu_item "1" "Create snapshot" "Create new snapshot"
        menu_item "2" "List snapshots" "Show snapshots with filters"
        menu_item "3" "Delete snapshots" "Remove snapshots by name/age"
        menu_item "4" "Rollback to snapshot" "Restore dataset to snapshot state"
        menu_item "5" "Cleanup (retention)" "Apply GFS retention policy"
        echo ""
        menu_item "b" "Back to main menu"
        
        read_choice "Select"
        
        case "$REPLY" in
            1)
                if select_dataset; then
                    echo ""
                    echo -ne "${C_PROMPT}Snapshot name (Enter for auto): ${C_RESET}"
                    read -r snap_name
                    
                    local opts=()
                    [[ -n "$snap_name" ]] && opts+=("-n" "$snap_name")
                    
                    run_script "zfs-snapshot.sh" create "$SELECTED_DATASET" "${opts[@]}"
                fi
                press_enter
                ;;
            2)
                run_script "zfs-snapshot.sh" list
                press_enter
                ;;
            3)
                run_script "zfs-snapshot.sh" delete --help
                echo ""
                echo -ne "${C_PROMPT}Enter full command (after 'delete'): ${C_RESET}"
                read -r delete_args
                
                if [[ -n "$delete_args" ]]; then
                    run_script "zfs-snapshot.sh" delete $delete_args
                fi
                press_enter
                ;;
            4)
                echo ""
                echo "Available snapshots:"
                zfs list -t snapshot -H -o name 2>/dev/null | head -20 || echo "No snapshots"
                echo ""
                echo -ne "${C_PROMPT}Enter snapshot name (dataset@snap): ${C_RESET}"
                read -r snapshot
                
                if [[ -n "$snapshot" ]]; then
                    run_script "zfs-snapshot.sh" rollback "$snapshot"
                fi
                press_enter
                ;;
            5)
                if select_dataset; then
                    echo ""
                    echo "Retention options:"
                    echo -ne "${C_PROMPT}Keep last N snapshots [5]: ${C_RESET}"
                    read -r keep_last
                    keep_last="${keep_last:-5}"
                    
                    echo -ne "${C_PROMPT}Keep N daily [7]: ${C_RESET}"
                    read -r keep_daily
                    keep_daily="${keep_daily:-7}"
                    
                    echo -ne "${C_PROMPT}Keep N weekly [4]: ${C_RESET}"
                    read -r keep_weekly
                    keep_weekly="${keep_weekly:-4}"
                    
                    echo -ne "${C_PROMPT}Keep N monthly [3]: ${C_RESET}"
                    read -r keep_monthly
                    keep_monthly="${keep_monthly:-3}"
                    
                    run_script "zfs-snapshot.sh" cleanup "$SELECTED_DATASET" \
                        --keep-last "$keep_last" \
                        --keep-daily "$keep_daily" \
                        --keep-weekly "$keep_weekly" \
                        --keep-monthly "$keep_monthly" \
                        --dry-run
                    
                    echo ""
                    if prompt_yn "Apply this cleanup?" "n"; then
                        run_script "zfs-snapshot.sh" cleanup "$SELECTED_DATASET" \
                            --keep-last "$keep_last" \
                            --keep-daily "$keep_daily" \
                            --keep-weekly "$keep_weekly" \
                            --keep-monthly "$keep_monthly" \
                            -y
                    fi
                fi
                press_enter
                ;;
            b|B) return ;;
            *) ;;
        esac
    done
}

menu_backup() {
    while true; do
        clear_screen
        menu_header "Backup & Restore"
        
        menu_item "1" "Create backup" "Create local backup file"
        menu_item "2" "Restore from backup" "Restore dataset from backup"
        menu_item "3" "List backups" "Show available backup files"
        menu_item "4" "Verify backup" "Check backup integrity"
        menu_item "5" "Send to remote" "Stream backup to remote server"
        menu_item "6" "Cleanup old backups" "Remove old backup files"
        echo ""
        menu_item "b" "Back to main menu"
        
        read_choice "Select"
        
        case "$REPLY" in
            1)
                if select_dataset; then
                    echo ""
                    echo "Compression options: gzip, zstd (recommended), lz4, none"
                    echo -ne "${C_PROMPT}Compression [zstd]: ${C_RESET}"
                    read -r compress
                    compress="${compress:-zstd}"
                    
                    if prompt_yn "Incremental backup?" "n"; then
                        run_script "zfs-backup.sh" create "$SELECTED_DATASET" -c "$compress" -i --progress
                    else
                        run_script "zfs-backup.sh" create "$SELECTED_DATASET" -c "$compress" --progress
                    fi
                fi
                press_enter
                ;;
            2)
                run_script "zfs-backup.sh" list
                echo ""
                echo -ne "${C_PROMPT}Backup file path: ${C_RESET}"
                read -r backup_file
                
                if [[ -n "$backup_file" ]]; then
                    echo -ne "${C_PROMPT}Target dataset: ${C_RESET}"
                    read -r target
                    
                    if [[ -n "$target" ]]; then
                        run_script "zfs-backup.sh" restore "$backup_file" "$target" --progress
                    fi
                fi
                press_enter
                ;;
            3)
                run_script "zfs-backup.sh" list
                press_enter
                ;;
            4)
                echo ""
                echo -ne "${C_PROMPT}Backup file path: ${C_RESET}"
                read -r backup_file
                
                if [[ -n "$backup_file" ]]; then
                    run_script "zfs-backup.sh" verify "$backup_file" --checksum -v
                fi
                press_enter
                ;;
            5)
                if select_dataset; then
                    echo ""
                    echo "Remote format: user@host:pool/dataset"
                    echo -ne "${C_PROMPT}Remote destination: ${C_RESET}"
                    read -r remote
                    
                    if [[ -n "$remote" ]]; then
                        if prompt_yn "Incremental send?" "n"; then
                            run_script "zfs-backup.sh" send "$SELECTED_DATASET" "$remote" -i --progress
                        else
                            run_script "zfs-backup.sh" send "$SELECTED_DATASET" "$remote" --progress
                        fi
                    fi
                fi
                press_enter
                ;;
            6)
                echo ""
                echo -ne "${C_PROMPT}Keep last N backups [10]: ${C_RESET}"
                read -r keep
                keep="${keep:-10}"
                
                run_script "zfs-backup.sh" cleanup --keep-last "$keep" --dry-run
                
                echo ""
                if prompt_yn "Apply this cleanup?" "n"; then
                    run_script "zfs-backup.sh" cleanup --keep-last "$keep" -y
                fi
                press_enter
                ;;
            b|B) return ;;
            *) ;;
        esac
    done
}

menu_incus() {
    while true; do
        clear_screen
        menu_header "Incus Integration"
        
        menu_item "1" "Initialize with ZFS" "Setup Incus with ZFS storage pool"
        menu_item "2" "Show storage info" "Display Incus storage configuration"
        echo ""
        echo -e "  ${C_MENU_DESC}(Future: container management, LXC support)${C_RESET}"
        echo ""
        menu_item "b" "Back to main menu"
        
        read_choice "Select"
        
        case "$REPLY" in
            1)
                run_script "zfs-incus-init.sh"
                press_enter
                ;;
            2)
                echo ""
                if command -v incus &>/dev/null; then
                    echo "Storage pools:"
                    incus storage list 2>/dev/null || echo "  (none)"
                    echo ""
                    echo "Networks:"
                    incus network list 2>/dev/null || echo "  (none)"
                else
                    echo "Incus is not installed"
                fi
                press_enter
                ;;
            b|B) return ;;
            *) ;;
        esac
    done
}

menu_cron() {
    while true; do
        clear_screen
        menu_header "Scheduled Tasks"
        
        menu_item "1" "Add new task" "Schedule snapshot/backup/cleanup/scrub"
        menu_item "2" "List tasks" "Show all scheduled tasks"
        menu_item "3" "Remove task" "Delete scheduled task by ID"
        menu_item "4" "Test run task" "Execute task manually"
        echo ""
        menu_item "b" "Back to main menu"
        
        read_choice "Select"
        
        case "$REPLY" in
            1)
                echo ""
                echo "Task types:"
                menu_item "1" "snapshot" "Daily snapshots"
                menu_item "2" "cleanup" "Cleanup with retention"
                menu_item "3" "backup" "Create backup"
                menu_item "4" "scrub" "Pool scrub"
                read_choice "Task type"
                
                local task_type=""
                case "$REPLY" in
                    1) task_type="snapshot" ;;
                    2) task_type="cleanup" ;;
                    3) task_type="backup" ;;
                    4) task_type="scrub" ;;
                esac
                
                if [[ -n "$task_type" ]] && select_pool; then
                    echo ""
                    echo "Schedule:"
                    menu_item "1" "Hourly"
                    menu_item "2" "Daily (02:00)"
                    menu_item "3" "Weekly (Sunday 02:00)"
                    menu_item "4" "Monthly (1st, 02:00)"
                    read_choice "Schedule"
                    
                    local schedule=""
                    case "$REPLY" in
                        1) schedule="--hourly" ;;
                        2) schedule="--daily" ;;
                        3) schedule="--weekly" ;;
                        4) schedule="--monthly" ;;
                    esac
                    
                    if [[ -n "$schedule" ]]; then
                        local opts=("--type" "$task_type" "--pool" "$SELECTED_POOL" "$schedule")
                        
                        if [[ "$task_type" == "cleanup" ]]; then
                            opts+=("--keep-daily" "7" "--keep-weekly" "4" "--keep-monthly" "3")
                        fi
                        
                        run_script "zfs-cron-setup.sh" add "${opts[@]}"
                    fi
                fi
                press_enter
                ;;
            2)
                run_script "zfs-cron-setup.sh" list
                press_enter
                ;;
            3)
                run_script "zfs-cron-setup.sh" list
                echo ""
                echo -ne "${C_PROMPT}Task ID to remove: ${C_RESET}"
                read -r task_id
                
                if [[ -n "$task_id" ]]; then
                    run_script "zfs-cron-setup.sh" remove --id "$task_id"
                fi
                press_enter
                ;;
            4)
                run_script "zfs-cron-setup.sh" list
                echo ""
                echo -ne "${C_PROMPT}Task ID to test: ${C_RESET}"
                read -r task_id
                
                if [[ -n "$task_id" ]]; then
                    if prompt_yn "Dry run first?" "y"; then
                        run_script "zfs-cron-setup.sh" test --id "$task_id" --dry-run
                    else
                        run_script "zfs-cron-setup.sh" test --id "$task_id"
                    fi
                fi
                press_enter
                ;;
            b|B) return ;;
            *) ;;
        esac
    done
}

menu_quick() {
    while true; do
        clear_screen
        menu_header "Quick Actions"
        
        menu_item "1" "Snapshot all pools" "Create snapshots for all pools"
        menu_item "2" "Health check all" "Run health check on all pools"
        menu_item "3" "Show scheduled tasks" "Quick view of cron jobs"
        menu_item "4" "Backup status" "Show recent backups summary"
        echo ""
        menu_item "b" "Back to main menu"
        
        read_choice "Select"
        
        case "$REPLY" in
            1)
                echo ""
                local pools
                pools=$(zpool list -H -o name 2>/dev/null || true)
                
                if [[ -z "$pools" ]]; then
                    echo "No pools found"
                else
                    while IFS= read -r pool; do
                        info "Creating snapshot for: $pool"
                        run_script "zfs-snapshot.sh" create "$pool" -r --prefix quick -q || true
                    done <<< "$pools"
                    success "Done!"
                fi
                press_enter
                ;;
            2)
                run_script "zfs-pool-health.sh" --all
                press_enter
                ;;
            3)
                run_script "zfs-cron-setup.sh" list
                press_enter
                ;;
            4)
                run_script "zfs-backup.sh" list
                press_enter
                ;;
            b|B) return ;;
            *) ;;
        esac
    done
}

# =============================================================================
# CLI ROUTING
# =============================================================================
route_command() {
    local category="$1"
    shift
    
    case "$category" in
        pool)
            route_pool "$@"
            ;;
        snapshot)
            "$SCRIPT_DIR/zfs-snapshot.sh" "$@"
            ;;
        backup)
            "$SCRIPT_DIR/zfs-backup.sh" "$@"
            ;;
        incus)
            route_incus "$@"
            ;;
        cron)
            "$SCRIPT_DIR/zfs-cron-setup.sh" "$@"
            ;;
        -h|--help|help)
            show_help
            ;;
        -v|--version|version)
            show_version
            ;;
        *)
            error "Unknown command: $category"
            echo "Use 'zfsh --help' for available commands"
            exit 1
            ;;
    esac
}

route_pool() {
    local action="${1:-}"
    shift || true
    
    case "$action" in
        create)
            "$SCRIPT_DIR/zfs-pool-create.sh" "$@"
            ;;
        info)
            "$SCRIPT_DIR/zfs-pool-info.sh" "$@"
            ;;
        expand)
            "$SCRIPT_DIR/zfs-pool-expand.sh" "$@"
            ;;
        health)
            "$SCRIPT_DIR/zfs-pool-health.sh" "$@"
            ;;
        -h|--help|help|"")
            echo "Pool commands:"
            echo "  zfsh pool create   - Create new ZFS pool"
            echo "  zfsh pool info     - Show pool information"
            echo "  zfsh pool expand   - Expand pool size"
            echo "  zfsh pool health   - Check pool health"
            echo ""
            echo "Use 'zfsh pool <command> --help' for command-specific help"
            ;;
        *)
            error "Unknown pool command: $action"
            exit 1
            ;;
    esac
}

route_incus() {
    local action="${1:-}"
    shift || true
    
    case "$action" in
        init)
            "$SCRIPT_DIR/zfs-incus-init.sh" "$@"
            ;;
        info)
            if command -v incus &>/dev/null; then
                incus storage list
                echo ""
                incus network list
            else
                error "Incus is not installed"
                exit 1
            fi
            ;;
        -h|--help|help|"")
            echo "Incus commands:"
            echo "  zfsh incus init   - Initialize Incus with ZFS pool"
            echo "  zfsh incus info   - Show Incus storage info"
            ;;
        *)
            error "Unknown incus command: $action"
            exit 1
            ;;
    esac
}

# =============================================================================
# MAIN
# =============================================================================
main() {
    # Parse common args first
    parse_common_args "$@"
    set -- "${REMAINING_ARGS[@]}"
    
    # Handle version/help flags
    for arg in "$@"; do
        case "$arg" in
            -v|--version)
                show_version
                exit 0
                ;;
            -h|--help)
                show_help
                exit 0
                ;;
        esac
    done
    
    # CLI mode if arguments provided
    if [[ $# -gt 0 ]]; then
        route_command "$@"
        exit $?
    fi
    
    # Interactive mode
    menu_main
}

main "$@"
